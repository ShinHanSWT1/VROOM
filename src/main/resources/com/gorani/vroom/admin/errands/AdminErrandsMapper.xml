<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gorani.vroom.admin.errand.AdminErrandsMapper">

    <select id="getSummary" resultType="map">
        SELECT e.total_count,
               e.unmatched,
               e.dday,
               e.completed_rate,
               p.errander_count
        FROM (SELECT COUNT(*)                                                   AS total_count,
                     SUM(CASE WHEN status = 'WAITING' THEN 1 ELSE 0 END)        AS unmatched,
                     SUM(CASE WHEN desired_at = CURRENT_DATE THEN 1 ELSE 0 END) AS dday,
                     SUM(CASE WHEN status = 'COMPLETED' THEN 1 ELSE 0 END)
                         / COUNT(*) * 100.0                                     AS completed_rate
              FROM ERRANDS) e

        CROSS JOIN
            (SELECT COUNT(*) AS errander_count
             FROM ERRANDER_PROFILES
             WHERE is_employee = TRUE) p
    </select>

    <select id="selectErrandList" parameterType="map" resultType="map">
        SELECT
        errands_id,
        title,
        dong_full_name,
        status,
        created_at,
        desired_at,
        errander_id FROM ERRANDS
        <where>
            <if test="keyword != null and keyword != ''">
                AND (title LIKE CONCAT('%', #{keyword}, '%') OR errands_id = #{keyword})
            </if>
            <if test="gu != null and gu != ''">
                AND dong_full_name LIKE CONCAT(#{gu}, '%')
            </if>
            <if test="dong != null and dong != ''">
                AND dong_code = #{dong}
            </if>
            <if test="regStart != null and regStart != ''">
                AND created_at &gt;= #{regStart}
            </if>
            <if test="regEnd != null and regEnd != ''">
                AND created_at &lt;= CONCAT(#{regEnd}, ' 23:59:59')
            </if>
            <if test="dueStart != null and dueStart != ''">
                AND desired_at &gt;= #{dueStart}
            </if>
            <if test="dueEnd != null and dueEnd != ''">
                AND desired_at &lt;= CONCAT(#{dueEnd}, ' 23:59:59')
            </if>
        </where>
        ORDER BY created_at DESC
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="countErrandList" parameterType="map" resultType="int">
        SELECT COUNT(*) FROM ERRANDS
        <where>
            <if test="keyword != null and keyword != ''">
                AND (title LIKE CONCAT('%', #{keyword}, '%') OR errands_id = #{keyword})
            </if>
            <if test="gu != null and gu != ''">
                AND dong_full_name LIKE CONCAT(#{gu}, '%')
            </if>
            <if test="dong != null and dong != ''">
                AND dong_code = #{dong}
            </if>
            <if test="regStart != null and regStart != ''">
                AND created_at &gt;= #{regStart}
            </if>
            <if test="regEnd != null and regEnd != ''">
                AND created_at &lt;= CONCAT(#{regEnd}, ' 23:59:59')
            </if>
        </where>
    </select>

    <select id="getErrandHistory" parameterType="long" resultType="map">
        SELECT
            a.id, a.assigned_at, a.status, a.reason,
            m.nickname AS errander_nickname
        FROM ERRAND_ASSIGNMENTS a
                 JOIN ERRANDER_PROFILES p ON a.errander_id = p.errander_id
                 JOIN MEMBERS m ON p.user_id = m.user_id
        WHERE a.errands_id = #{errandsId}
        ORDER BY a.assigned_at DESC
    </select>
</mapper>