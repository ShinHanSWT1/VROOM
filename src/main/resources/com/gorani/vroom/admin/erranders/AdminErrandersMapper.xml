<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gorani.vroom.admin.erranders.AdminErrandersMapper">

    <!-- 상단 요약 -->
    <!-- 전체 부름이, 활성 부름이(정지 ＋ 일시정지, 승인대기), 오늘 활동(최근 7일 활동), 평균 완료율 -->
    <select id="getSummary" resultType="map">
        <![CDATA[
            SELECT p.total,
                   p.activated,
                   p.banned,
                   p.waiting,
                   p.today_activated,
                   p.recent7_activated,
                   r.avg_complete_rate
            FROM (SELECT COUNT(*)                                                                          AS total,
                         SUM(CASE WHEN active_status = 'ACTIVE' THEN 1 ELSE 0 END)                         AS activated,
                         SUM(CASE WHEN active_status IN ('SUSPENDED', 'BANNED') THEN 1 ELSE 0 END)         AS banned,
                         SUM(CASE WHEN approval_status = 'PENDING' THEN 1 ELSE 0 END)                      AS waiting,
                         SUM(CASE WHEN active_status = 'ACTIVE'
                                           AND last_active_at >= CURRENT_DATE - INTERVAL 1 DAY THEN 1 ELSE 0 END) AS today_activated,
                         SUM(CASE WHEN active_status = 'ACTIVE'
                                     AND last_active_at >= CURRENT_DATE - INTERVAL 7 DAY THEN 1 ELSE 0 END)       AS recent7_activated
                  FROM ERRANDER_PROFILES) p
            LEFT JOIN
                 (SELECT ROUND(AVG(complete_rate), 2) AS avg_complete_rate
                  FROM (SELECT errander_id,
                               SUM(CASE WHEN status = 'COMPLETED' THEN 1 ELSE 0 END) * 1.0 / COUNT(*) AS complete_rate
                        FROM ERRANDS
                        GROUP BY errander_id) t) r
            ON 1 = 1
        ]]>
    </select>


    <!-- 부름이 검색 -->
    <select id="searchErranders" parameterType="map" resultType="map">
        <![CDATA[
            SELECT
                m.user_id,
                m.phone,
                p.errander_id,
                m.nickname,
                p.approval_status,
                p.active_status,
                p.complete_rate,
                p.rating_avg,
                p.last_active_at
            FROM MEMBERS m
            JOIN ERRANDER_PROFILES p ON m.user_id = p.user_id
            WHERE m.role = 'ERRANDER'
        ]]>

            <if test="keyword != null and keyword != ''">
                AND (
                m.nickname LIKE CONCAT('%', #{keyword}, '%')
                OR p.errander_id LIKE CONCAT('%', #{keyword}, '%')
                )
            </if>

            <if test="approveStatus != null and approveStatus != ''">
                AND p.approval_status = #{approveStatus}
            </if>

            <if test="activeStatus != null and activeStatus != ''">
                AND p.active_status = #{activeStatus}
            </if>

            <if test="reviewScope != null">
                AND p.rating_avg >= #{reviewScope}
            </if>
        <![CDATA[
            ORDER BY p.approved_at DESC
            LIMIT #{limit} OFFSET #{offset}
        ]]>

    </select>

    <!-- 검색된 총 부름이 수 -->
    <select id="countErranders" parameterType="map" resultType="int">
        <![CDATA[
            SELECT COUNT(*)
            FROM MEMBERS m
            JOIN ERRANDER_PROFILES p ON m.user_id = p.user_id
            WHERE m.role = 'ERRANDER'
        ]]>

        <if test="keyword != null and keyword != ''">
            AND (
            m.nickname LIKE CONCAT('%', #{keyword}, '%')
            OR p.errander_id LIKE CONCAT('%', #{keyword}, '%')
            )
        </if>

        <if test="approveStatus != null and approveStatus != ''">
            AND p.approval_status = #{approveStatus}
        </if>

        <if test="activeStatus != null and activeStatus != ''">
            AND p.active_status = #{activeStatus}
        </if>

        <if test="reviewScope != null">
            AND p.rating_avg >= #{reviewScope}
        </if>
    </select>


    <!-- 부름이 승인/반려 모달 -->
    <!-- 사용자 id, 심부름 id, 닉네임, 이메일, 휴대폰, 활동 상태, 최근활동일, 활동 동네, 제출 서류 -->
    <resultMap id="erranderResumeMap" type="map">
        <id property="user_id" column="user_id"/>
        <result property="errander_id" column="errander_id"/>
        <result property="nickname" column="nickname"/>
        <result property="email" column="email"/>
        <result property="phone" column="phone"/>
        <result property="last_login_at" column="last_login_at"/>
        <result property="status" column="status"/>
        <result property="address1" column="address1"/>
        <result property="address2" column="address2"/>

        <collection property="documents" javaType="java.util.ArrayList" ofType="map">
            <result property="file_url" column="file_url"/>
            <result property="doc_type" column="doc_type"/>
        </collection>
    </resultMap>

    <select id="getErranderApprovalDetail"
            parameterType="long" resultMap="erranderResumeMap">
        <![CDATA[
            SELECT
                e.user_id, e.errander_id, m.nickname, m.email, m.phone, m.last_login_at, m.status,
                l1.full_name AS address1, l2.full_name AS address2,
                d.file_url, d.doc_type
            FROM ERRANDER_PROFILES e
                     JOIN MEMBERS m ON e.user_id = m.user_id
                     LEFT JOIN LEGAL_DONG l1 ON e.dong_code1 = l1.dong_code
                     LEFT JOIN LEGAL_DONG l2 ON e.dong_code2 = l2.dong_code
                     LEFT JOIN ERRANDER_DOCUMENTS d ON e.errander_id = d.errander_id AND d.status = 'SUBMITTED'
            WHERE e.errander_id = #{erranderId}
        ]]>
    </select>

    <!-- 부름이 승인 상태 변경 -->
    <update id="updateErranderApprovalStatus">
        <![CDATA[
        UPDATE ERRANDER_PROFILES SET approval_status = #{status}, approved_at = NOW()
        WHERE errander_id = #{erranderId}
        ]]>
    </update>

    <!-- 부름이 활성화 상태 변경 -->
    <update id="updateErranderActiveStatus">
        <![CDATA[
            UPDATE ERRANDER_PROFILES SET active_status = #{status}
            WHERE errander_id = #{erranderId}
        ]]>
    </update>
</mapper>