<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gorani.vroom.user.profile.UserMapper">

    <!-- 결과 매핑 (DB 컬럼 -> VO 필드) -->
    <resultMap id="UserProfileResultMap" type="com.gorani.vroom.user.profile.UserProfileVO">
        <id property="userId" column="user_id"/>
        <result property="nickname" column="nickname"/>
        <result property="profileImage" column="profile_image"/>
        <result property="mannerTemp" column="manner_score"/>
    </resultMap>

    <!-- 프로필 조회 -->
    <!--사용자 아이디, 닉네임, 프로필 이미지, 매너점수 -->
    <select id="findById" parameterType="Long" resultMap="UserProfileResultMap">
        SELECT user_id, nickname, profile_image, manner_score
        FROM MEMBERS
        WHERE user_id = #{userId}
          AND status = 'ACTIVE'
    </select>

    <!-- 프로필 수정 (닉네임, 프로필 이미지) -->
    <update id="update" parameterType="com.gorani.vroom.user.profile.UserProfileVO">
        UPDATE MEMBERS
        SET nickname = #{nickname},
            profile_image = #{profileImage}
        WHERE user_id = #{userId}
    </update>

    <!-- 프로필 이미지만 수정 -->
    <update id="updateProfileImage">
        UPDATE MEMBERS
        SET profile_image = #{profileImage}
        WHERE user_id = #{userId}
    </update>

    <!-- 내가 신청한 심부름 목록 조회 -->
    <select id="findErrandsByUserId" parameterType="Long" resultType="com.gorani.vroom.user.profile.ErrandsVO">
        SELECT e.errands_id, e.user_id, e.errander_id, e.title, e.description,
               e.desired_at, e.reward_amount, e.expense_amount, e.status,
               e.created_at, e.updated_at, e.category_id, e.dong_code,
               d.gungu_name, d.dong_name
        FROM ERRANDS e
        LEFT JOIN LEGAL_DONG d ON e.dong_code = d.dong_code
        WHERE e.user_id = #{userId}
        ORDER BY e.created_at DESC
    </select>
    
    <!-- 신고 등록 -->
    <insert id="insertIssueTicket" parameterType="com.gorani.vroom.user.profile.IssueTicketVO">
        INSERT INTO ISSUE_TICKETS (type, title, content, priority, status, errand_id, user_id, target_user_id)
        VALUES (#{type}, #{title}, #{content}, #{priority}, 'RECEIVED', #{errandId}, #{userId}, #{targetUserId})
    </insert>

    <!-- errandId로 심부름꾼(errander) ID 조회 -->
    <select id="findErranderIdByErrandId" parameterType="Long" resultType="Long">
        SELECT errander_id
        FROM ERRANDS
        WHERE errands_id = #{errandId}
    </select>

    <!-- 비밀번호 조회 -->
    <select id="findPasswordByUserId" parameterType="Long" resultType="String">
        SELECT pwd
        FROM MEMBERS
        WHERE user_id = #{userId}
          AND status = 'ACTIVE'
    </select>

    <!-- 회원 탈퇴 처리 (status를 DELETED로 변경) -->
    <update id="withdrawUser" parameterType="Long">
        UPDATE MEMBERS
        SET status = 'DELETED',
            deleted_at = NOW()
        WHERE user_id = #{userId}
    </update>

</mapper>
