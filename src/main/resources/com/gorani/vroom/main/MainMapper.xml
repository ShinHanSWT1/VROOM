<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gorani.vroom.main.MainMapper">

    <!-- 심부름 카테고리 리스트 조회 -->
    <select id="selectErrandsCategoryList" resultType="com.gorani.vroom.errand.post.CategoryVO">
        SELECT
            id,
            name,
            default_image_url
        FROM CATEGORIES
        ORDER BY id;
    </select>

    <!-- 메인 페이지 최신 심부름 목록 조회 -->
    <select id="selectMainErrandList" resultType="com.gorani.vroom.errand.post.ErrandListVO">
        SELECT
            e.errands_id     AS errandsId,
            e.title          AS title,
            e.reward_amount  AS rewardAmount,
            e.created_at     AS createdAt,
            e.dong_code      AS dongCode,
            d.full_name      AS dongFullName,
            e.category_id    AS categoryId,
            c.name           AS categoryName,

            -- 이미지 우선순위: 1. 게시글 이미지 -> 2. 카테고리 기본 이미지
            COALESCE(
                (SELECT ei.image_url
                 FROM ERRANDS_IMAGE ei
                 WHERE ei.errands_id = e.errands_id
                 ORDER BY ei.sort_order ASC, ei.image_id ASC
                 LIMIT 1),
                c.default_image_url
            ) AS imageUrl

        FROM ERRANDS e
        LEFT JOIN CATEGORIES c ON c.id = e.category_id
        LEFT JOIN LEGAL_DONG d ON d.dong_code = e.dong_code
        <where>
            e.status = 'WAITING' -- 진행 중인 심부름만
            <if test="dongCode != null and dongCode != ''">
                AND e.dong_code = #{dongCode}
            </if>
        </where>
        ORDER BY e.created_at DESC
        LIMIT 6
    </select>

    <!-- 메인 페이지 커뮤니티 인기글 조회 -->
    <select id="selectMainPopularPostList" resultType="com.gorani.vroom.community.CommunityPostVO">
        SELECT
            c.post_id,
            c.title,
            c.content,
            c.view_count,
            c.like_count,
            c.comment_count,
            c.created_at,
            m.nickname,
            c.dong_code,
            d.dong_name,
            c.category_id,
            cc.category_name,
            -- 인기 점수 계산 (좋아요*3 + 댓글*2 + 조회수*1)
            (c.like_count * 3 + c.comment_count * 2 + c.view_count * 1) AS popularity_score
        FROM COMMUNITY c
        LEFT JOIN COMMUNITY_CATEGORY cc ON c.category_id = cc.category_id
        LEFT JOIN MEMBERS m ON c.user_id = m.user_id
        LEFT JOIN LEGAL_DONG d ON c.dong_code = d.dong_code
        <where>
            c.deleted_at IS NULL
            AND c.created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY) -- 최근 7일 이내
            <if test="dongCode != null and dongCode != ''">
                AND c.dong_code = #{dongCode}
            </if>
        </where>
        ORDER BY popularity_score DESC, c.created_at DESC
        LIMIT 6
    </select>

</mapper>