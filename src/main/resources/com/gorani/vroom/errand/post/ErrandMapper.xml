<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gorani.vroom.errand.post.ErrandMapper">

    <!-- 공통 WHERE: 검색/필터 조건 -->
    <sql id="ErrandListWhere">
        <where>
            <!-- 처음엔 status 조건은 빼고, 데이터 뜨는지부터 확인 -->
            <!-- AND e.status = #{status} -->

            <if test="q != null and q != ''">
                AND (
                    e.title LIKE CONCAT('%', #{q}, '%')
                    OR e.description LIKE CONCAT('%', #{q}, '%')
                )
            </if>

            <if test="categoryId != null">
                AND e.category_id = #{categoryId}
            </if>

            <if test="dongCode != null and dongCode != ''">
                AND e.dong_code = #{dongCode}
            </if>
        </where>
    </sql>

    <!-- 목록 조회 -->
    <select id="selectErrandList" parameterType="map" resultType="com.gorani.vroom.errand.post.ErrandListVO">

        SELECT
            e.errands_id     AS errandsId,
            e.user_id        AS userId,
            e.title          AS title,
            e.reward_amount  AS rewardAmount,
            e.expense_amount AS expenseAmount,
            e.desired_at     AS desiredAt,
            e.created_at     AS createdAt,
            e.status         AS status,
            e.category_id    AS categoryId,
            e.dong_code      AS dongCode
        FROM ERRANDS e
        <include refid="ErrandListWhere"/>

        <choose>
            <when test="sort == 'price_desc'">
                ORDER BY e.reward_amount DESC, e.created_at DESC
            </when>
            <when test="sort == 'price_asc'">
                ORDER BY e.reward_amount ASC, e.created_at DESC
            </when>
            <when test="sort == 'desired_at'">
                ORDER BY e.desired_at ASC, e.created_at DESC
            </when>
            <otherwise>
                ORDER BY e.created_at DESC
            </otherwise>
        </choose>

        LIMIT #{limit} OFFSET #{offset}
    </select>

    <!-- 총 개수 -->
    <select id="countErrandList" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM ERRANDS e
        <include refid="ErrandListWhere"/>
    </select>
    
    <!-- 심부름 게시글 상세 조회 -->
    <select id="selectErrandDetail"
            parameterType="long"
            resultType="com.gorani.vroom.errand.post.ErrandDetailVO">

        SELECT
            e.errands_id     AS errandsId,
            e.user_id        AS userId,
            e.title          AS title,
            e.description    AS description,
            e.reward_amount  AS rewardAmount,
            e.expense_amount AS expenseAmount,
            e.desired_at     AS desiredAt,
            e.created_at     AS createdAt,
            e.status         AS status,
            e.category_id    AS categoryId,
            e.dong_code      AS dongCode
        FROM ERRANDS e
        WHERE e.errands_id = #{errandsId}

    </select>

</mapper>
