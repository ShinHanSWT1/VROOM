<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gorani.vroom.errand.chat.ChatMapper">

    <!-- 채팅방 조회 -->
    <select id="selectChatRoomByErrandsId" resultType="com.gorani.vroom.errand.chat.ChatRoomVO">
	    SELECT cr.room_id, cr.errands_id, cr.errander_id, cr.created_at
	    FROM CHAT_ROOM cr
	    WHERE cr.errands_id = #{errandsId}
	    ORDER BY cr.room_id DESC
	    LIMIT 1
	</select>
	
    <select id="selectChatRoomById" resultType="com.gorani.vroom.errand.chat.ChatRoomVO">
        SELECT room_id, errands_id, errander_id, created_at
        FROM CHAT_ROOM
        WHERE room_id = #{roomId}
    </select>
    
    <select id="selectErrandsIdByRoomId" resultType="long">
	  SELECT errands_id
	  FROM CHAT_ROOM
	  WHERE room_id = #{roomId}
	</select>    
    
    <!-- 채팅방 생성 -->
    <insert id="insertChatRoom"
        parameterType="com.gorani.vroom.errand.chat.ChatRoomVO"
        useGeneratedKeys="true"
        keyProperty="roomId">
	  INSERT INTO CHAT_ROOM (errands_id, errander_id)
	  VALUES (#{errandsId}, #{erranderId})
	</insert>
    
    <!-- 참여자 조회 -->
    <select id="selectParticipant" resultType="com.gorani.vroom.errand.chat.ChatParticipantVO">
        SELECT participant_id, room_id, user_id, room_role, joined_at, is_active
        FROM CHAT_PARTICIPANT
        WHERE room_id = #{roomId}
          AND user_id = #{userId}
          AND is_active = 1
        LIMIT 1
    </select>
    
    <select id="selectParticipantsByRoomId" resultType="com.gorani.vroom.errand.chat.ChatParticipantVO">
        SELECT participant_id, room_id, user_id, room_role, joined_at, 
               is_active
        FROM CHAT_PARTICIPANT
        WHERE room_id = #{roomId}
    </select>
    
    <!-- 참여자 추가 -->
    <insert id="insertParticipant">
        INSERT INTO CHAT_PARTICIPANT (room_id, user_id, room_role, joined_at, is_active)
        VALUES (#{roomId}, #{userId}, #{roomRole}, CURRENT_TIMESTAMP, 1)
    </insert>
    
    <!-- 참여자 비활성화 -->
    <update id="updateParticipantInactive">
        UPDATE CHAT_PARTICIPANT
        SET is_active = 0
        WHERE room_id = #{roomId}
          AND user_id = #{userId}
    </update>
    
    <!-- 메시지 조회 -->
    <select id="selectMessagesByRoomId" resultType="com.gorani.vroom.errand.chat.ChatMessageVO">
        SELECT 
            cm.message_id,
            cm.room_id,
            cm.sender_user_id,
            cm.message_type,
            cm.content,
            cm.created_at,
            cm.is_deleted
        FROM CHAT_MESSAGE cm
        LEFT JOIN MEMBERS m ON cm.sender_user_id = m.user_id
        WHERE cm.room_id = #{roomId}
          AND cm.is_deleted = 0
        ORDER BY cm.created_at ASC
    </select>
    
    <!-- 메시지 전송 -->
    <insert id="insertMessage" useGeneratedKeys="true" keyProperty="messageId">
        INSERT INTO CHAT_MESSAGE (room_id, sender_user_id, message_type, content, created_at, is_deleted)
        VALUES (#{roomId}, #{senderUserId}, #{messageType}, #{content}, CURRENT_TIMESTAMP, 0)
    </insert>
    
    <!-- 심부름 작성자 조회 -->
    <select id="selectErrandOwnerUserId" resultType="long">
        SELECT user_id
        FROM ERRANDS
        WHERE errands_id = #{errandsId}
    </select>
    
    <!-- 심부름 정보 조회 (채팅방용) -->
    <select id="selectErrandInfoForChat" resultType="com.gorani.vroom.errand.chat.ChatRoomVO">
	  <![CDATA[
	  SELECT 
	      e.errands_id AS errandsId,
	      e.status AS status,   
	      e.title AS errandTitle,
	      e.description AS errandDescription,
	      CONCAT(ld.gungu_name, ' ', ld.dong_name) AS errandLocation,
	      e.reward_amount AS rewardAmount,
	      e.expense_amount AS expenseAmount,
	
	      (
	        SELECT ei.image_url
	        FROM ERRANDS_IMAGE ei
	        WHERE ei.errands_id = e.errands_id
	        ORDER BY ei.sort_order ASC, ei.image_id ASC
	        LIMIT 1
	      ) AS errandImageUrl,

	      c.default_image_url AS categoryDefaultImageUrl,
	
	      m.nickname AS ownerNickname
	  FROM ERRANDS e
	  LEFT JOIN LEGAL_DONG ld ON e.dong_code = ld.dong_code
	  LEFT JOIN MEMBERS m ON e.user_id = m.user_id
	  
	  LEFT JOIN CATEGORIES c ON c.id = e.category_id
	  WHERE e.errands_id = #{errandsId}
	  LIMIT 1
	  ]]>
	</select>
    
    <!-- 사용자가 특정 심부름의 채팅방 참여자인지 확인 -->
    <select id="countParticipantByErrandsIdAndUserId" resultType="int">
        SELECT COUNT(*)
        FROM CHAT_PARTICIPANT cp
        INNER JOIN CHAT_ROOM cr ON cp.room_id = cr.room_id
        WHERE cr.errands_id = #{errandsId}
          AND cp.user_id = #{userId}
          AND cp.is_active = 1
    </select>
    
    <!-- 현재 errands 상태 조회 -->
	<select id="selectErrandStatusByErrandsId" resultType="string">
	  SELECT status
	  FROM ERRANDS
	  WHERE errands_id = #{errandsId}
	</select>
	
	<!-- 1) WAITING -> MATCHED (채팅 시작: 한번만 성공해야 함) -->
	<update id="updateErrandStatusWaitingToMatched">
	  UPDATE ERRANDS
	  SET status = 'MATCHED'
	  WHERE errands_id = #{errandsId}
	    AND status = 'WAITING'
	</update>
	
	<!-- 2) MATCHED -> CONFIRMED1 (수락: 한번만 성공해야 함) -->
	<update id="updateErrandStatusMatchedToConfirmed1">
	  UPDATE ERRANDS
	  SET status = 'CONFIRMED1'
	  WHERE errands_id = #{errandsId}
	    AND status = 'MATCHED'
	</update>
	
	<!-- 3) MATCHED -> WAITING (거절: 다시 모집) -->
	<update id="updateErrandStatusMatchedToWaiting">
	  UPDATE ERRANDS
	  SET status = 'WAITING'
	  WHERE errands_id = #{errandsId}
	    AND status = 'MATCHED'
	</update>
	
	<!-- 4) 상태 히스토리 insert -->
	<insert id="insertErrandsStatusHistory">
	  INSERT INTO ERRAND_STATUS_HISTORY
	    (errands_id, from_status, to_status, changed_by_type, changed_by_id, changed_at)
	  VALUES
	    (#{errandsId}, #{fromStatus}, #{toStatus}, #{changedByType}, #{changedById}, NOW())
	</insert>
	
	<select id="countChatRoomByErrandsId" resultType="int">
	  SELECT COUNT(*)
	  FROM CHAT_ROOM
	  WHERE errands_id = #{errandsId}
	</select>
	
	<!-- 상대방 정보 조회 (채팅방 헤더용) -->
	<select id="selectPartnerInfoForChat" resultType="com.gorani.vroom.errand.chat.ChatRoomVO">
	  <![CDATA[
	  SELECT
	      m.user_id        AS partnerUserId,
	      m.nickname       AS partnerNickname,
	      m.profile_image  AS partnerProfileImage,
	      m.manner_score   AS partnerMannerScore
	  FROM CHAT_ROOM cr
	  JOIN CHAT_PARTICIPANT cp
	    ON cp.room_id = cr.room_id
	   AND cp.is_active = 1
	  JOIN MEMBERS m
	    ON m.user_id = cp.user_id
	  WHERE cr.errands_id = #{errandsId}
	    AND cp.user_id <> #{currentUserId}
	  ORDER BY cp.participant_id DESC
	  LIMIT 1
	  ]]>
	</select>
	
	<select id="selectErranderUserIdByRoomId" resultType="long">
	  SELECT cp.user_id
	  FROM CHAT_PARTICIPANT cp
	  WHERE cp.room_id = #{roomId}
	    AND cp.room_role = 'ERRANDER'
	    AND cp.is_active = 1
	    ORDER BY cp.participant_id DESC
	  LIMIT 1
	</select>
	
	<insert id="upsertParticipantActive">
	  INSERT INTO CHAT_PARTICIPANT (room_id, user_id, room_role, joined_at, is_active)
	  VALUES (#{roomId}, #{userId}, #{role}, CURRENT_TIMESTAMP, 1)
	  ON DUPLICATE KEY UPDATE
	    room_role = VALUES(room_role),
	    is_active = 1
	</insert>
	
	<update id="deactivateParticipant">
	  UPDATE CHAT_PARTICIPANT
	  SET is_active = 0
	  WHERE room_id = #{roomId}
	    AND user_id = #{userId}
	</update>
	
	<update id="deactivateErrandersByRoomId">
	  UPDATE CHAT_PARTICIPANT
	  SET is_active = 0
	  WHERE room_id = #{roomId}
	    AND room_role = 'ERRANDER'
	</update>
	
	<select id="selectChatRoomByErrandsIdAndErranderId"
          resultType="com.gorani.vroom.errand.chat.ChatRoomVO">
	    SELECT room_id, errands_id, errander_id, created_at
	    FROM CHAT_ROOM
	    WHERE errands_id = #{errandsId}
	      AND errander_id = #{erranderId}
	    ORDER BY room_id DESC
	    LIMIT 1
	  </select>
	  
	  <select id="existsReview" resultType="int">
	    SELECT COUNT(*)
	    FROM REVIEWS
	    WHERE errand_id = #{errandId}
	      AND reviewer_user_id = #{reviewerUserId}
	  </select>
	
	  <insert id="insertReview">
	    INSERT INTO REVIEWS (
	      errand_id, rating, comment, created_at,
	      reviewer_user_id, reviewee_user_id
	    ) VALUES (
	      #{errandId}, #{rating}, #{comment}, NOW(),
	      #{reviewerUserId}, #{revieweeUserId}
	    )
	  </insert>
	
</mapper>