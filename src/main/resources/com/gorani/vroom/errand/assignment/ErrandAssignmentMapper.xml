<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gorani.vroom.errand.assignment.ErrandAssignmentMapper">

  <select id="selectOwnerUserId" resultType="long">
    SELECT user_id
    FROM ERRANDS
    WHERE errands_id = #{errandsId}
  </select>
  
  <select id="selectErranderIdByUserId" resultType="long">
    SELECT errander_id
    FROM ERRANDER_PROFILES
    WHERE user_id = #{userId}
    LIMIT 1
  </select>

  <update id="updateErrandStatusWaitingToMatched">
    UPDATE ERRANDS
    SET status = 'MATCHED',
        updated_at = CURRENT_TIMESTAMP
    WHERE errands_id = #{errandsId}
      AND status = 'WAITING'
  </update>

  <insert id="insertMatchedAssignment">
    INSERT INTO ERRAND_ASSIGNMENTS (user_id, errands_id, errander_id, assign_type, status)
    VALUES (#{userId}, #{errandsId}, #{erranderId}, 'AUTO', 'MATCHED')
  </insert>

  <insert id="insertStatusHistory">
    INSERT INTO ERRAND_STATUS_HISTORY
      (errands_id, from_status, to_status, changed_by_type, changed_by_id)
    VALUES
      (#{errandsId}, #{fromStatus}, #{toStatus}, #{changedByType}, #{changedById})
  </insert>

</mapper>
